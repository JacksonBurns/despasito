

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>despasito.thermodynamics.calc &mdash; DESPASITO  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> DESPASITO
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../input_output.html">Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../eos.html">Equations of State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thermo.html">Thermodynamic Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fitparams.html">Parametrization</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DESPASITO</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../thermodynamics.html">despasito.thermodynamics</a> &raquo;</li>
        
      <li>despasito.thermodynamics.calc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for despasito.thermodynamics.calc</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains our thermodynamic calculations. Calculation of pressure, chemical potential, and max density are handled by an eos object so that these functions can be used with any EOS. The thermo module contains a series of wrapper to handle the inputs and outputs of these functions.</span>

<span class="sd">.. todo:: </span>
<span class="sd">    Add types of scipy solving methods and the types available</span>
<span class="sd">    </span>
<span class="sd">    Update if statement to generalize as a factory</span>
<span class="sd">    </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">spo</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="k">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">import</span> <span class="n">gaussian_filter1d</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="c1">#import deap</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">fund_constants</span> <span class="k">as</span> <span class="n">const</span>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc CC Params                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_CC_Pguess"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_CC_Pguess.html#despasito.thermodynamics.calc.calc_CC_Pguess">[docs]</a><span class="k">def</span> <span class="nf">calc_CC_Pguess</span><span class="p">(</span><span class="n">xilist</span><span class="p">,</span> <span class="n">Tlist</span><span class="p">,</span> <span class="n">CriticalProp</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the Mie parameters of a mixture from the mixed critical properties of the pure components. </span>
<span class="sd">    From: Mejia, A., C. Herdes, E. Muller. Ind. Eng. Chem. Res. 2014, 53, 4131-4141</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xilist : list[list[xi]]</span>
<span class="sd">        List of different Mole fractions of each component, sum(xi) should equal 1.0 for each set. Each set of components corresponds to a temperature in Tlist.</span>
<span class="sd">    Tlist : list[float]</span>
<span class="sd">        Temperature of the system corresponding to composition in xilist [K]</span>
<span class="sd">    CriticalProp : list[list]</span>
<span class="sd">        List of critical properties :math:`T_C`, :math:`P_C`, :math:`\omega`, :math:`\rho_{0.7}`, :math:`Z_C`, :math:`V_C`, and molecular weight, where each of these properties is a list of values for each bead.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Psatm : list[float]</span>
<span class="sd">        A list of guesses in pressure based on critical properties, of the same length as xilist and Tlist [Pa]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">Tc</span><span class="p">,</span> <span class="n">Pc</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">rho_7</span><span class="p">,</span> <span class="n">Zc</span><span class="p">,</span> <span class="n">Vc</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">CriticalProp</span>

    <span class="c1">############## Calculate Mixed System Mie Parameters</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="o">-</span><span class="mf">0.847</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.2387</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">omega</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Omega is outside of the range that these correlations are valid&quot;</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">14.8359</span><span class="p">,</span> <span class="mf">22.2019</span><span class="p">,</span> <span class="mf">7220.9599</span><span class="p">,</span> <span class="mf">23193.4750</span><span class="p">,</span> <span class="o">-</span><span class="mf">6207.4663</span><span class="p">,</span> <span class="mf">1732.9600</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.9630</span><span class="p">,</span> <span class="mf">468.7358</span><span class="p">,</span> <span class="o">-</span><span class="mf">983.6038</span><span class="p">,</span> <span class="mf">914.3608</span><span class="p">,</span> <span class="o">-</span><span class="mf">1383.4441</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1284</span><span class="p">,</span> <span class="mf">1.6772</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.4049</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1592</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.8966</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.9808</span><span class="p">,</span> <span class="mf">10.6330</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2041</span><span class="p">,</span> <span class="mf">4.2503</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6205</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8019</span><span class="p">,</span> <span class="mf">1.7086</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5333</span><span class="p">,</span> <span class="mf">1.0536</span><span class="p">]</span>

    <span class="n">Tcm</span><span class="p">,</span> <span class="n">Pcm</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">Psatm</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">jj</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Psatm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xilist</span><span class="p">):</span>
            <span class="c1"># Mixture alpha</span>
            <span class="n">omegaij</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">omegaij</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">omegaij</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">l_r</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">tmp2</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_r</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_r</span> <span class="o">-</span> <span class="mf">6.</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_r</span> <span class="o">/</span> <span class="mf">6.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_r</span> <span class="o">-</span> <span class="mf">6.</span><span class="p">))</span>
            <span class="n">al_tmp</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_r</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">))</span>
            <span class="c1"># Mixture Critical Properties Stewart-Burkhardt-Voo</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Tc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**.</span><span class="mi">5</span> <span class="o">+</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">Tc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">**.</span><span class="mi">5</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Tc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">Tc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**.</span><span class="mi">5</span> <span class="o">+</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pc</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">**.</span><span class="mi">5</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">tmp2</span><span class="o">**</span><span class="mf">2.</span>
            <span class="n">Tc_tmp</span> <span class="o">=</span> <span class="n">K</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">J</span>
            <span class="n">Pc_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">/</span> <span class="n">J</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
            <span class="c1"># Mixture Pressure Prausnitz-Gunn</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Tlist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">Tlist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">):</span>
                <span class="n">R</span> <span class="o">=</span> <span class="mf">8.3144598</span>  <span class="c1"># [kg*m^2/(s^2*mol*K)] Gas constant</span>
                <span class="n">tmp1</span> <span class="o">=</span> <span class="n">Zc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Zc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">tmp2</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">Pc_tmp</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">Tc_tmp</span> <span class="o">*</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">tmp2</span>
            <span class="c1"># Mixture Molar Density, Plocker Knapp</span>
            <span class="n">Mij</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">8.</span> <span class="o">/</span> <span class="n">Mij</span> <span class="o">/</span> <span class="p">((</span><span class="n">rho_7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rho_7</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">))</span><span class="o">**</span><span class="mf">3.</span>
            <span class="n">Nav</span> <span class="o">=</span> <span class="mf">6.0221415e+23</span>  <span class="c1"># avogadros number</span>
    
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">al_tmp</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">al_tmp</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">Tc_star</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">tmp2</span><span class="p">)</span>
            <span class="n">eps_tmp</span> <span class="o">=</span> <span class="n">Tc_tmp</span> <span class="o">/</span> <span class="n">Tc_star</span>  <span class="c1"># [K], multiply by kB to change to energy units</span>
    
            <span class="n">tmp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">j</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">al_tmp</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">tmp4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">k</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">al_tmp</span><span class="o">**</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span>
            <span class="n">rho_star</span> <span class="o">=</span> <span class="n">tmp3</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">tmp4</span><span class="p">)</span>
            <span class="n">sig_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_star</span> <span class="o">/</span> <span class="n">rho_tmp</span> <span class="o">/</span> <span class="n">Nav</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span>
    
            <span class="c1"># Calculate Psat</span>
            <span class="n">eos_dict</span><span class="p">[</span><span class="s1">&#39;massi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Mij</span><span class="p">])</span>
            <span class="n">eos_dict</span><span class="p">[</span><span class="s1">&#39;nui&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">eos_dict</span><span class="p">[</span><span class="s1">&#39;beads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bead&#39;</span><span class="p">]</span>
            <span class="n">eos_dict</span><span class="p">[</span><span class="s1">&#39;beadlibrary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bead&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;l_r&#39;</span><span class="p">:</span> <span class="n">l_r</span><span class="p">,</span>
                    <span class="s1">&#39;epsilon&#39;</span><span class="p">:</span> <span class="n">eps_tmp</span><span class="p">,</span>
                    <span class="s1">&#39;Vks&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;Sk&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;l_a&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">Mij</span><span class="p">,</span>
                    <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sig_tmp</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">eos</span> <span class="o">=</span> <span class="n">eos</span><span class="p">(</span><span class="s2">&quot;saft.gamma_mie&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">eos_dict</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="p">(</span><span class="n">Tlist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Tc_tmp</span><span class="p">):</span>
                <span class="n">Psat_tmp</span><span class="p">,</span> <span class="n">rholsat_tmp</span><span class="p">,</span> <span class="n">rhogsat_tmp</span> <span class="o">=</span> <span class="n">calc_Psat</span><span class="p">(</span><span class="n">Tlist</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span> <span class="n">eos</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Psat_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat_tmp</span><span class="p">):</span>
                <span class="n">Psatm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">break</span>
    
            <span class="c1"># Save values</span>
            <span class="c1"># Nothing is done with rholsat_tmp and rhogsat_tmp</span>
            <span class="n">Tcm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tc_tmp</span><span class="p">)</span>
            <span class="n">Pcm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pc_tmp</span><span class="p">)</span>
            <span class="n">sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_tmp</span><span class="p">)</span>
            <span class="n">epsilon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eps_tmp</span><span class="p">)</span>
            <span class="n">Psatm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Psat_tmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Psatm</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                      Pressure-Density Curve                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="PvsRho"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.PvsRho.html#despasito.thermodynamics.calc.PvsRho">[docs]</a><span class="k">def</span> <span class="nf">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">minrhofrac</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">500000.0</span><span class="p">),</span> <span class="n">rhoinc</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">vspacemax</span><span class="o">=</span><span class="mf">1.0E-4</span><span class="p">,</span> <span class="n">maxpack</span><span class="o">=</span><span class="mf">0.65</span><span class="p">):</span>

    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the Mie parameters of a mixture from the mixed critical properties of the pure components. </span>
<span class="sd">    From: Mejia, A., C. Herdes, E. Muller. Ind. Eng. Chem. Res. 2014, 53, 4131-4141</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    minrhofrac : float, Optional, default: (1.0/500000.0)</span>
<span class="sd">        Fraction of the maximum density used to calculate, and is equal to, the minimum density of the density array. The minimum density is the reciprocal of the maximum specific volume used to calculate the roots. Passed from inputs to through the dictionary rhodict.</span>
<span class="sd">    rhoinc : float, Optional, default: 5.0</span>
<span class="sd">        The increment between density values in the density array. Passed from inputs to through the dictionary rhodict.</span>
<span class="sd">    vspacemax : float, Optional, default: 1.0E-4</span>
<span class="sd">        Maximum increment between specific volume array values. After conversion from density to specific volume, the increment values are compared to this value. Passed from inputs to through the dictionary rhodict.</span>
<span class="sd">    maxpack : float, Optional, default: 0.65</span>
<span class="sd">        Maximum packing fraction. Passed from inputs to through the dictionary rhodict.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vlist : numpy.ndarray</span>
<span class="sd">        Specific volume array. Length depends on values in rhodict [:math:`m^3`/mol]</span>
<span class="sd">    Plist : numpy.ndarray</span>
<span class="sd">        Pressure associated with specific volume of system with given temperature and composition [Pa]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>

    <span class="c1">#estimate the maximum density based on the hard sphere packing fraction, part of EOS</span>
    <span class="n">maxrho</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">density_max</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">maxpack</span><span class="o">=</span><span class="n">maxpack</span><span class="p">)</span>
    <span class="c1">#min rho is a fraction of max rho, such that minrho &lt;&lt; rhogassat</span>
    <span class="n">minrho</span> <span class="o">=</span> <span class="n">maxrho</span> <span class="o">*</span> <span class="n">minrhofrac</span>
    <span class="c1">#list of densities for P,rho and P,v</span>
    <span class="n">rholist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minrho</span><span class="p">,</span> <span class="n">maxrho</span><span class="p">,</span> <span class="n">rhoinc</span><span class="p">)</span>
    <span class="c1">#check rholist to see when the spacing</span>
    <span class="n">vspace</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rholist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rholist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">vspace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vspacemax</span><span class="p">:</span>
        <span class="n">vspaceswitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vspace</span> <span class="o">&gt;</span> <span class="n">vspacemax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rholist_2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rholist</span><span class="p">[</span><span class="n">vspaceswitch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">minrho</span><span class="p">,</span> <span class="n">vspacemax</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rholist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rholist_2</span><span class="p">,</span> <span class="n">rholist</span><span class="p">[</span><span class="n">vspaceswitch</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:])</span>

    <span class="c1">#compute Pressures (Plist) for rholsit</span>
    <span class="n">Plist</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">rholist</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Nav</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

    <span class="c1">#Flip Plist and rholist arrays</span>
    <span class="n">Plist</span> <span class="o">=</span> <span class="n">Plist</span><span class="p">[:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rholist</span> <span class="o">=</span> <span class="n">rholist</span><span class="p">[:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vlist</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rholist</span>

    <span class="k">return</span> <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span></div>


<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                      Pressure-Volume Spline                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="PvsV_spline"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.PvsV_spline.html#despasito.thermodynamics.calc.PvsV_spline">[docs]</a><span class="k">def</span> <span class="nf">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit arrays of specific volume and pressure values to a cubic Univariate Spline.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vlist : numpy.ndarray</span>
<span class="sd">        Specific volume array. Length depends on values in rhodict [:math:`m^3`/mol]</span>
<span class="sd">    Plist : numpy.ndarray</span>
<span class="sd">        Pressure associated with specific volume of system with given temperature and composition [Pa]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pvspline : obj</span>
<span class="sd">        Function object of pressure vs. specific volume</span>
<span class="sd">    roots : list</span>
<span class="sd">        List of specific volume roots. Subtract a system pressure from the output of Pvsrho to find density of vapor and/or liquid densities.</span>
<span class="sd">    extrema : list</span>
<span class="sd">        List of specific volume values corresponding to local minima and maxima.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">Psmoothed</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">Plist</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">Pvspline</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Psmoothed</span><span class="p">)</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">roots</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">Pvspline</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Psmoothed</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span><span class="o">.</span><span class="n">roots</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">extrema</span><span class="p">:</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="n">Plist</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roots</span><span class="p">,[</span><span class="n">root2</span><span class="p">])</span>

    <span class="c1">#PvsV_plot(vlist, Plist, Pvspline, markers=extrema)</span>

    <span class="k">return</span> <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                      Pressure-Volume Spline                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="PvsV_plot"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.PvsV_plot.html#despasito.thermodynamics.calc.PvsV_plot">[docs]</a><span class="k">def</span> <span class="nf">PvsV_plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">,</span> <span class="n">Pvspline</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot pressure vs. specific volume.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vlist : numpy.ndarray</span>
<span class="sd">        Specific volume array. Length depends on values in rhodict [:math:`m^3`/mol]</span>
<span class="sd">    Plist : numpy.ndarray</span>
<span class="sd">        Pressure associated with specific volume of system with given temperature and composition [Pa]</span>
<span class="sd">    Pvspline : obj</span>
<span class="sd">        Function object of pressure vs. specific volume</span>
<span class="sd">    markers : list, Optional, default: []</span>
<span class="sd">        List of plot markers used in plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span><span class="n">Plist</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orig.&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">vlist</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Smoothed&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">vlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">markers</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">markers</span><span class="p">[</span><span class="n">k</span><span class="p">]],[</span><span class="nb">min</span><span class="p">(</span><span class="n">Plist</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">Plist</span><span class="p">)],</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Specific Volume [$m^3$/mol]&quot;</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pressure [Pa]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc Psat                             #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_Psat"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_Psat.html#despasito.thermodynamics.calc.calc_Psat">[docs]</a><span class="k">def</span> <span class="nf">calc_Psat</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the saturated pressure, gas and liquid densities for a single component system given Temperature and Mie parameters</span>
<span class="sd">    T: Saturated Temperature in Kelvin</span>
<span class="sd">    minrhofrac: Fraction of maximum hard sphere packing fraction for gas density</span>
<span class="sd">    rhoinc: spacing densities for rholist in mol/m^3. Smaller values will generate a more accurate curve at increasing computational cost</span>
<span class="sd">    Returns Saturated Pressure in Pa, liquid denisty, and gas density in mol/m^3</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Psat : float</span>
<span class="sd">        Saturation pressure given system information [Pa]</span>
<span class="sd">    rhov : float</span>
<span class="sd">        Density of vapor at saturation pressure [mol/:math:`m^3`]</span>
<span class="sd">    rhol : float</span>
<span class="sd">        Density of liquid at saturation pressure [mol/:math:`m^3`]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">xi</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiple components have compositions greater than 10%, check code for source&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xi</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiple components have compositions greater than 0. Do you mean to obtain the saturation pressure of </span><span class="si">{}</span><span class="s2"> with a mole fraction of </span><span class="si">{}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">xi</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>

    <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span> <span class="o">=</span> <span class="n">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="o">**</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">extrema</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error: One of the components is above its critical point, add an exception to setPsat&#39;</span><span class="p">)</span>
        <span class="n">Psat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind_Pmin1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Plist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind_Pmax1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Plist</span><span class="p">[</span><span class="n">ind_Pmin1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">ind_Pmin1</span>

        <span class="n">Pmaxsearch</span> <span class="o">=</span> <span class="n">Plist</span><span class="p">[</span><span class="n">ind_Pmax1</span><span class="p">]</span>

        <span class="n">Pconverged</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># If the pressure is negative (under tension), we search from a value just above vacuum </span>
        <span class="n">Pminsearch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Pconverged</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Plist</span><span class="p">[</span><span class="n">ind_Pmin1</span><span class="p">:</span><span class="n">ind_Pmax1</span><span class="p">]))</span>

        <span class="c1">#search Pressure that gives equal area in maxwell construction</span>
        <span class="n">Psat</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">eq_area</span><span class="p">,</span>
                               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Plist</span><span class="p">,</span> <span class="n">vlist</span><span class="p">),</span>
                               <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">Pminsearch</span> <span class="o">*</span> <span class="mf">1.0001</span><span class="p">,</span> <span class="n">Pmaxsearch</span> <span class="o">*</span> <span class="o">.</span><span class="mi">9999</span><span class="p">),</span>
                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span>

        <span class="c1">#Using computed Psat find the roots in the maxwell construction to give liquid (first root) and vapor (last root) densities</span>
        <span class="n">Psat</span> <span class="o">=</span> <span class="n">Psat</span><span class="o">.</span><span class="n">x</span>
        <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="o">-</span><span class="n">Psat</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="n">Plist</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">-</span><span class="n">Psat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roots</span><span class="p">,[</span><span class="n">root2</span><span class="p">])</span>

    <span class="c1">#Psat,rholsat,rhogsat</span>
    <span class="k">return</span> <span class="n">Psat</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Eq Area                               #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="eq_area"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.eq_area.html#despasito.thermodynamics.calc.eq_area">[docs]</a><span class="k">def</span> <span class="nf">eq_area</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">Pv</span><span class="p">,</span> <span class="n">vlist</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function used to calculate the saturation pressure.</span>

<span class="sd">    Note: If the curve hasn&#39;t decayed to 0 yet, estimate the remaining area as a triangle. This isn&#39;t super accurate but we are just using the saturation pressure to get started.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shift : float</span>
<span class="sd">        Guess in Psat value used to translate the pressure vs. specific volume curve [Pa]</span>
<span class="sd">    Pv : numpy.ndarray</span>
<span class="sd">        Pressure associated with specific volume of system with given temperature and composition [Pa]</span>
<span class="sd">    vlist : numpy.ndarray</span>
<span class="sd">        Specific volume array. Length depends on values in rhodict [:math:`m^3`/mol]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj_value : float</span>
<span class="sd">        Output of objective function, the addition of the positive area between first two roots, and negative area between second and third roots, quantity squared.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Pv</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">roots</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># If the curve hasn&#39;t decayed to 0 yet, estimate the remaining area as a triangle. This isn&#39;t super accurate but we are just using the saturation pressure to get started.</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="n">Pv</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Pvspline</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">root2</span><span class="o">-</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Pressure curve without cubic properties has wrongly been accepted. Try decreasing minrhofrac&quot;</span><span class="p">)</span>
        <span class="n">PvsV_plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Pv</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Pvspline</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="n">extrema</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc Rho V Full                       #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_rhov"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_rhov.html#despasito.thermodynamics.calc.calc_rhov">[docs]</a><span class="k">def</span> <span class="nf">calc_rhov</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes vapor density under system conditions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rhov : float</span>
<span class="sd">        Density of vapor at system pressure [mol/:math:`m^3`]</span>
<span class="sd">    flag : int</span>
<span class="sd">        A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means we should assume ideal gas</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span> <span class="o">=</span> <span class="n">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="o">**</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">Plist</span> <span class="o">=</span> <span class="n">Plist</span><span class="o">-</span><span class="n">P</span>
    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Find rhov: P </span><span class="si">{}</span><span class="s2"> Pa, roots </span><span class="si">{}</span><span class="s2"> m^3/mol&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">roots</span><span class="p">))</span>

    <span class="n">l_roots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Pvspline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 1: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">vlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">Plist</span><span class="p">)</span><span class="o">+</span><span class="n">P</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 0: This T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a vapor at this pressure. Warning! approaching critical fluid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;    Flag 3: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, won&#39;t produce a fluid (vapor or liquid) at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">PvsV_plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">,</span> <span class="n">Pvspline</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="n">extrema</span><span class="p">)</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">P</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span><span class="o">+</span><span class="n">P</span><span class="p">):</span>
            <span class="c1">#logger.debug(&quot;Extrema: {}&quot;.format(extrema))</span>
            <span class="c1">#logger.debug(&quot;Roots: {}&quot;.format(roots))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 1: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Flag 0: This T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a vapor at this pressure. Warning! approaching critical fluid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">P</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 1: This T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid under tension at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Flag 4: There should be a third root! Assume ideal gas P: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 3 roots</span>
        <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span> <span class="c1"># vapor or critical fluid</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">rho_tmp</span><span class="o">*.</span><span class="mi">99</span><span class="p">,</span> <span class="n">rho_tmp</span><span class="o">*</span><span class="mf">1.01</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Pdiff</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span><span class="o">*</span><span class="n">Pdiff</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">Pdiff</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">),</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Plist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Density value could not be bounded with (rhomin,rhomax), </span><span class="si">{}</span><span class="s2">. Using approximate density value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">Pdiff</span><span class="p">,</span> <span class="n">rho_tmp</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">)</span>
                <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">rho_tmp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Flag: 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means we should assume ideal gas</span>
    <span class="k">return</span> <span class="n">rho_tmp</span><span class="p">,</span> <span class="n">flag</span></div>


<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc Rho L Full                       #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_rhol"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_rhol.html#despasito.thermodynamics.calc.calc_rhol">[docs]</a><span class="k">def</span> <span class="nf">calc_rhol</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes liquid density under system conditions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rhol : float</span>
<span class="sd">        Density of liquid at system pressure [mol/:math:`m^3`]</span>
<span class="sd">    flag : int</span>
<span class="sd">        A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Get roots and local minima and maxima </span>
    <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span> <span class="o">=</span> <span class="n">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="o">**</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">Plist</span> <span class="o">=</span> <span class="n">Plist</span><span class="o">-</span><span class="n">P</span>
    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Find rhol: P </span><span class="si">{}</span><span class="s2"> Pa, roots </span><span class="si">{}</span><span class="s2"> m^3/mol&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">roots</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">extrema</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;One extrema at </span><span class="si">{}</span><span class="s2">, assume weird minima behavior. Check your parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> 

    <span class="c1"># Assess roots, what is the liquid density</span>
    <span class="n">l_roots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># zero roots</span>
        <span class="k">if</span> <span class="n">Pvspline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">vlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 1: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">vlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">Plist</span><span class="p">)</span><span class="o">+</span><span class="n">P</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and yi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 0: This T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a vapor at this pressure. Warning! approaching critical fluid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;    Flag 3: The T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, won&#39;t produce a fluid (vapor or liquid) at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">PvsV_plot</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="o">+</span><span class="n">P</span><span class="p">,</span> <span class="n">Pvspline</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="n">extrema</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># 2 roots</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">P</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 1: This T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid under tension at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># There should be three roots, but the values of specific volume don&#39;t go far enough to pick up the last one</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">l_roots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 1 root</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 2: The T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a critical fluid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">P</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span><span class="o">+</span><span class="n">P</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Flag 1: The T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a liquid at this pressure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Flag 0: This T and xi, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, combination produces a vapor at this pressure. Warning! approaching critical fluid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">xi</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 3 roots</span>
        <span class="n">rho_tmp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span> <span class="c1"># liquid or critical fluid</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">rho_tmp</span><span class="o">*.</span><span class="mi">99</span><span class="p">,</span> <span class="n">rho_tmp</span><span class="o">*</span><span class="mf">1.01</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Pdiff</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span><span class="o">*</span><span class="n">Pdiff</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">Pdiff</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">),</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Plist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Density value could not be bounded with (rhomin,rhomax), </span><span class="si">{}</span><span class="s2">. Using approximate density value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">Pdiff</span><span class="p">,</span> <span class="n">rho_tmp</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">)</span>
                <span class="n">rho_tmp</span> <span class="o">=</span> <span class="n">rho_tmp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Flag: 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true</span>
    <span class="k">return</span> <span class="n">rho_tmp</span><span class="p">,</span> <span class="n">flag</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc Pdiff                            #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="Pdiff"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.Pdiff.html#despasito.thermodynamics.calc.Pdiff">[docs]</a><span class="k">def</span> <span class="nf">Pdiff</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">Pset</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate difference between set point pressure and computed pressure for a given density</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rho : float</span>
<span class="sd">        Density of system [mol/:math:`m^3`]</span>
<span class="sd">    Pset : float</span>
<span class="sd">        Guess in pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pdiff : float</span>
<span class="sd">        Difference in set pressure and predicted pressure given system conditions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">Pguess</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Nav</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Pguess</span> <span class="o">-</span> <span class="n">Pset</span><span class="p">)</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                          Calc phi vapor                            #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_phiv"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_phiv.html#despasito.thermodynamics.calc.calc_phiv">[docs]</a><span class="k">def</span> <span class="nf">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes vapor fugacity coefficient under system conditions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    phiv : float</span>
<span class="sd">        Fugacity coefficient of vapor at system pressure</span>
<span class="sd">    rhov : float</span>
<span class="sd">        Density of vapor at system pressure [mol/:math:`m^3`]</span>
<span class="sd">    flag : int</span>
<span class="sd">        Flag identifying the fluid type. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means ideal gas is assumed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_rhov</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flagv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">phiv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
        <span class="n">rhov</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    rhov set to 0.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">muiv</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">chemicalpotential</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rhov</span><span class="p">]),</span> <span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">phiv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">muiv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                         Calc phi liquid                            #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_phil"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_phil.html#despasito.thermodynamics.calc.calc_phil">[docs]</a><span class="k">def</span> <span class="nf">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes liquid fugacity coefficient under system conditions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    rhol : float</span>
<span class="sd">        Density of liquid at system pressure [mol/:math:`m^3`]</span>
<span class="sd">    flag : int</span>
<span class="sd">        Flag identifying the fluid type. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_rhol</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flagl</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">phil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>
        <span class="n">rhol</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    rhol set to 0.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">muil</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">chemicalpotential</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rhol</span><span class="p">]),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">phil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">muil</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc P range                          #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_Prange_xi"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_Prange_xi.html#despasito.thermodynamics.calc.calc_Prange_xi">[docs]</a><span class="k">def</span> <span class="nf">calc_Prange_xi</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">Pmin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain min and max pressure values, where the liquid mole fraction is set and the objective function at each of those values is of opposite sign.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    Pmin : float, Optional, default: 1000.0</span>
<span class="sd">        Minimum pressure in pressure range that restricts searched space.</span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Prange : list</span>
<span class="sd">        List of min and max pressure range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">yi_global</span>

    <span class="c1"># Guess a range from Pmin to the local max of the liquid curve</span>
    <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span> <span class="o">=</span> <span class="n">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="o">**</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">):</span>
        <span class="n">Pmax</span> <span class="o">=</span> <span class="mi">100000</span> <span class="c1"># 1 MPa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span>
    <span class="n">Parray</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pmin</span><span class="p">,</span> <span class="n">Pmax</span><span class="p">]</span>

    <span class="c1">#################### Find Pressure range and Objective Function values</span>

    <span class="c1"># Root of min from liquid curve is absolute minimum</span>
    <span class="n">ObjArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">yi_range</span> <span class="o">=</span> <span class="n">yi</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="c1"># Find Obj Function for Min pressure above</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phil</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Estimated minimum pressure is too low.&quot;</span><span class="p">)</span>
            <span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Pmin</span>
            <span class="k">continue</span>
        <span class="n">yi_range</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">solve_yi_xiT</span><span class="p">(</span><span class="n">yi_range</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
        <span class="n">ObjArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimated Minimum Pressure: </span><span class="si">{}</span><span class="s2">,  Obj. Func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ObjArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ObjArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">maxiter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Proper minimum pressure for liquid density could not be found&quot;</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find Obj function for Max Pressure above</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Parray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phil</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">yi_range</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">solve_yi_xiT</span><span class="p">(</span><span class="n">yi_range</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
            <span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimate Maximum Pressure: </span><span class="si">{}</span><span class="s2">,  Obj. Func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Parray</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tmp_dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tmp_dif</span> <span class="o">&gt;</span> <span class="n">tmp_sum</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got the pressure range!&quot;</span><span class="p">)</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Pguess</span> <span class="o">=</span> <span class="o">-</span><span class="n">intercept</span> <span class="o">/</span> <span class="n">slope</span>

                <span class="c1">#plt.plot(Parray,ObjArray)</span>
                <span class="c1">#plt.plot([Pguess,Pguess],[ObjArray[-1],ObjArray[-2]],&#39;k&#39;)</span>
                <span class="c1">#plt.plot([Parray[0],Parray[-1]],[0,0],&#39;k&#39;)</span>
                <span class="c1">#plt.ylabel(&quot;Obj. Function&quot;)</span>
                <span class="c1">#plt.xlabel(&quot;Pressure / Pa&quot;)</span>
                <span class="c1">#plt.show()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">z</span> <span class="o">==</span> <span class="n">maxiter</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A change in sign for the objective function could not be found, inspect progress&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Parray</span><span class="p">,</span> <span class="n">ObjArray</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Obj. Function&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pressure / Pa&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Parray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phil</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fugacity coefficient should not be NaN&quot;</span><span class="p">)</span>
                <span class="n">yi_range</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">solve_yi_xiT</span><span class="p">(</span><span class="n">yi_range</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
                <span class="n">ObjArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New Estimate for Maximum Pressure: </span><span class="si">{}</span><span class="s2">,  Obj. Func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">Prange</span> <span class="o">=</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">ObjRange</span> <span class="o">=</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Pmin, Pmax]: </span><span class="si">{}</span><span class="s2">, Obj. Values: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Prange</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ObjRange</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial guess in pressure: </span><span class="si">{}</span><span class="s2"> Pa&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pguess</span><span class="p">))</span>

    <span class="n">yi_global</span> <span class="o">=</span> <span class="n">yi_range</span>

    <span class="k">return</span> <span class="n">Prange</span><span class="p">,</span> <span class="n">Pguess</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc P range                          #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_Prange_yi"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_Prange_yi.html#despasito.thermodynamics.calc.calc_Prange_yi">[docs]</a><span class="k">def</span> <span class="nf">calc_Prange_yi</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">Pmin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain min and max pressure values, where the vapor mole fraction is set and the objective function at each of those values is of opposite sign.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    Pmin : float, Optional, default: 1000.0</span>
<span class="sd">        Minimum pressure in pressure range that restricts searched space.</span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Prange : list</span>
<span class="sd">        List of min and max pressure range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">xi_global</span>

    <span class="c1"># Guess a range from Pmin to the local max of the liquid curve</span>
    <span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span> <span class="o">=</span> <span class="n">PvsRho</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="o">**</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">Pvspline</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">extrema</span> <span class="o">=</span> <span class="n">PvsV_spline</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="n">Plist</span><span class="p">)</span>

    <span class="c1"># Calculation the highest pressure possbile</span>
    <span class="n">Pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Pvspline</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span>
    <span class="n">Parray</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pmin</span><span class="p">,</span> <span class="n">Pmax</span><span class="p">]</span>

    <span class="c1">############################# Test</span>
    <span class="n">pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Pmin</span><span class="p">,</span><span class="n">Pmax</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">pressure2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">Pmax</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pressures</span><span class="p">,</span><span class="n">pressure2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">obj_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pressures</span><span class="p">:</span>
        <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">solve_xi_yiT</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
        <span class="n">obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span> <span class="o">*</span> <span class="n">phiv</span> <span class="o">/</span> <span class="n">phil</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pressures</span><span class="p">,</span><span class="n">obj_list</span><span class="p">,</span><span class="s2">&quot;.-&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Pmin</span><span class="p">,</span><span class="n">Pmax</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1">#################### Find Pressure range and Objective Function values</span>

    <span class="n">ObjArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">xi_range</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Parray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="n">xi_range</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">solve_xi_yiT</span><span class="p">(</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
        <span class="n">ObjArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span> <span class="o">*</span> <span class="n">phiv</span> <span class="o">/</span> <span class="n">phil</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimate Minimum pressure: </span><span class="si">{}</span><span class="s2">,  Obj. Func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ObjArray</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ObjArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                <span class="n">ObjArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimate Maximum pressure: </span><span class="si">{}</span><span class="s2">,  Obj. Func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ObjArray</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c1"># Check pressure range</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tmp_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tmp_dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tmp_dif</span> <span class="o">&gt;=</span> <span class="n">tmp_sum</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got the pressure range!&quot;</span><span class="p">)</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">Parray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="n">ObjArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">Parray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Pguess</span> <span class="o">=</span> <span class="o">-</span><span class="n">intercept</span> <span class="o">/</span> <span class="n">slope</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newPmin</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="k">if</span> <span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">newPmin</span><span class="p">:</span>
                    <span class="n">Parray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">newPmin</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No VLE data may be found given this temperature and vapor composition. If there are no errors in parameter definitions, consider updating the thermo function &#39;solve_xi_yiT&#39;.&quot;</span><span class="p">)</span>
            
    <span class="n">Prange</span> <span class="o">=</span> <span class="n">Parray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">ObjRange</span> <span class="o">=</span> <span class="n">ObjArray</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Pmin, Pmax]: </span><span class="si">{}</span><span class="s2">, Obj. Values: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Prange</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ObjRange</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial guess in pressure: </span><span class="si">{}</span><span class="s2"> Pa&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pguess</span><span class="p">))</span>

    <span class="n">xi_global</span> <span class="o">=</span> <span class="n">xi_range</span>

    <span class="k">return</span> <span class="n">Prange</span><span class="p">,</span> <span class="n">Pguess</span></div>


<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                       Solve Yi for xi and T                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="solve_yi_xiT"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_yi_xiT.html#despasito.thermodynamics.calc.solve_yi_xiT">[docs]</a><span class="k">def</span> <span class="nf">solve_yi_xiT</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find vapor mole fraction given pressure, liquid mole fraction, and temperature. Objective function is the sum of the predicted &quot;mole numbers&quot; predicted by the computed fugacity coefficients. Note that by &quot;mole number&quot; we mean that the prediction will only sum to 1 when the correct pressure is chosen in the outer loop. In this inner loop, we seek to find a mole fraction that is converged to reproduce itself in a prediction. If it hasn&#39;t, the new &quot;mole numbers&quot; are normalized into mole fractions and used as the next guess.</span>
<span class="sd">    In the case that a guess doesn&#39;t produce a gas or critical fluid, we use another function to produce a new guess.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Guess in vapor mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    maxiter : int, Optional, default: 30</span>
<span class="sd">        Maximum number of iteration for both the outer pressure and inner vapor mole fraction loops</span>
<span class="sd">    tol : float, Optional, default: 1e-6</span>
<span class="sd">        Tolerance in sum of predicted yi &quot;mole numbers&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    phiv : float</span>
<span class="sd">        Fugacity coefficient of vapor at system pressure</span>
<span class="sd">    flag : int</span>
<span class="sd">        Flag identifying the fluid type. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means ideal gas is assumed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">yi_global</span>

    <span class="n">yi</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">yi_total</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span><span class="p">)]</span>
    <span class="n">flag_check_vapor</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Make sure we only search for vapor compositions once</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;T </span><span class="si">{}</span><span class="s2">, xi </span><span class="si">{}</span><span class="s2">, phil </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>

        <span class="n">yi_tmp</span> <span class="o">=</span> <span class="n">yi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    yi guess </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi_tmp</span><span class="p">))</span>

        <span class="c1"># Try yi</span>
        <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi_tmp</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phiv</span><span class="p">))</span> <span class="ow">or</span> <span class="n">flagv</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">flag_check_vapor</span><span class="p">):</span> <span class="c1"># If vapor density doesn&#39;t exist</span>
            <span class="n">flag_check_vapor</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Composition doesn&#39;t produce a vapor, let&#39;s find one!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">yi</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">):</span>
                <span class="n">yinew</span> <span class="o">=</span> <span class="n">find_new_yi</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
                <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yinew</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
                <span class="n">yinew</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yinew</span> <span class="o">=</span> <span class="n">yi</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phiv</span><span class="p">)):</span>
                <span class="n">phiv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Fugacity coefficient of vapor should not be NaN&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yinew</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span>

        <span class="c1"># Check for bouncing between values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi_total</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">tmp1</span> <span class="o">=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="o">/</span><span class="mi">1000</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">tmp1</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">):</span>
                <span class="c1"># This occurs when the P vs. v curve doesn&#39;t cross the 0 axis, there could be a larger problem causing this, but in my experience, it&#39;s because the curve is not long enough to converge to zero. Instead of the possible endless increase in vector length and a substantial increase in computational time, we simply set the fugacity coefficient to ideal and the density to 0. When an iteration on our assumption produces a vapor near ideality, it then may predict an ideal gas. This causes the constant back and forth that really isn&#39;t that important to solve, as the fugacity coefficients are unity regardless.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    yi_total is bouncing between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">, choose the lowest value (outer loop obj. function).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">),</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">yinew</span> <span class="o">=</span> <span class="n">yi</span>
                    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi_tmp</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    yi calc </span><span class="si">{}</span><span class="s2">, phiv </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yinew</span><span class="p">,</span><span class="n">phiv</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Old yi_total: </span><span class="si">{}</span><span class="s2">, New yi_total: </span><span class="si">{}</span><span class="s2">, Change: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> 

        <span class="c1"># Check convergence</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span><span class="o">-</span><span class="n">yi_total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yi_tmp</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">yi_tmp</span><span class="p">[</span><span class="n">yi_tmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">yi2</span> <span class="o">=</span> <span class="n">yinew</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yi2</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">yi_global</span> <span class="o">=</span> <span class="n">yi_tmp</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Found yi&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">yi_total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">))</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="n">yinew</span>

    <span class="c1">## If yi wasn&#39;t found in defined number of iterations</span>
    <span class="n">yi_tmp</span> <span class="o">=</span> <span class="n">yi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">yinew</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>

    <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yi_tmp</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">yi_tmp</span><span class="p">[</span><span class="n">yi_tmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">maxiter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">yi2</span> <span class="o">=</span> <span class="n">yinew</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yinew</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;    More than </span><span class="si">{}</span><span class="s1"> iterations needed. Error in Smallest Fraction: </span><span class="si">{}</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">tmp</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If difference is greater than 10%</span>
            <span class="n">yinew</span> <span class="o">=</span> <span class="n">find_new_yi</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="n">yinew</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">obj_yi</span><span class="p">,</span> <span class="n">yinew</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">))</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="n">yinew</span><span class="o">.</span><span class="n">x</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj_yi</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;    Find yi with root algorithm, yi </span><span class="si">{}</span><span class="s1">, obj </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Inner Loop Final yi: </span><span class="si">{}</span><span class="s2">, Final Error on Smallest Fraction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi_tmp</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yi2</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">yi_tmp</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                       Solve Yi for xi and T                        #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="solve_xi_yiT"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_xi_yiT.html#despasito.thermodynamics.calc.solve_xi_yiT">[docs]</a><span class="k">def</span> <span class="nf">solve_xi_yiT</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find liquid mole fraction given pressure, vapor mole fraction, and temperature. Objective function is the sum of the predicted &quot;mole numbers&quot; predicted by the computed fugacity coefficients. Note that by &quot;mole number&quot; we mean that the prediction will only sum to 1 when the correct pressure is chosen in the outer loop. In this inner loop, we seek to find a mole fraction that is converged to reproduce itself in a prediction. If it hasn&#39;t, the new &quot;mole numbers&quot; are normalized into mole fractions and used as the next guess.</span>
<span class="sd">    In the case that a guess doesn&#39;t produce a liquid or critical fluid, we use another function to produce a new guess.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Guess in liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    phiv : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    maxiter : int, Optional, default: 20</span>
<span class="sd">        Maximum number of iteration for both the outer pressure and inner vapor mole fraction loops</span>
<span class="sd">    tol : float, Optional, default: 1e-6</span>
<span class="sd">        Tolerance in sum of predicted xi &quot;mole numbers&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    flag : int</span>
<span class="sd">        Flag identifying the fluid type. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">xi_global</span>

    <span class="n">xi</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">xi_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>

        <span class="n">xi</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    xi guess </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>

        <span class="c1"># Try xi</span>
        <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phil</span><span class="p">))</span> <span class="ow">or</span> <span class="n">flagl</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># If liquid density doesn&#39;t exist</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This composition under these system conditions doesn&#39;t produce a liquid or critical fluid. This system must be approaching its critical point and has a suitably small pressure. No contingency function has been established.&quot;</span><span class="p">)</span>

        <span class="n">xinew</span> <span class="o">=</span> <span class="n">yi</span> <span class="o">*</span> <span class="n">phiv</span> <span class="o">/</span> <span class="n">phil</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    xi calc </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xinew</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Old xi_total: </span><span class="si">{}</span><span class="s2">, New xi_total: </span><span class="si">{}</span><span class="s2">, Change: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xi_total</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span><span class="o">-</span><span class="n">xi_total</span><span class="p">))</span>

        <span class="c1"># Check convergence</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span><span class="o">-</span><span class="n">xi_total</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xi</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">xi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xi2</span> <span class="o">=</span> <span class="n">xinew</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi2</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">xi_global</span> <span class="o">=</span> <span class="n">xi</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Found xi&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">xinew</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>
            <span class="n">xi_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>

    <span class="c1">## If xi wasn&#39;t found in defined number of iterations</span>
    <span class="n">xinew</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>

    <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xi</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">xi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">maxiter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">xi2</span> <span class="o">=</span> <span class="n">xinew</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;    More than </span><span class="si">{}</span><span class="s1"> iterations needed. Error in Smallest Fraction: </span><span class="si">{}</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi2</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Inner Loop Final xi: </span><span class="si">{}</span><span class="s2">, Final Error on Smallest Fraction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi2</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span> <span class="o">/</span> <span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">flagl</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                       Find new Yi                                  #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>


<div class="viewcode-block" id="find_new_yi"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.find_new_yi.html#despasito.thermodynamics.calc.find_new_yi">[docs]</a><span class="k">def</span> <span class="nf">find_new_yi</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search vapor mole fraction combinations for a new estimate that produces a vapor density.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#    # have three functions, make sum close to zero, mui isn&#39;t np.nan, and rho is a vapor</span>
    <span class="c1">#    deap.creator.create(&quot;FitnessMulti&quot;,deap.base.Fitness,weights=(-1.0, -1.0, 0.5))</span>
    <span class="c1">#    deap.creator.create(&quot;Inividual&quot;, list, fitness=deap.creator.FitnessMax)</span>
    <span class="c1">#    toolbox = deap.base.Toolbox()</span>
    <span class="c1"># # NoteHere, make individuals add up to 1?</span>
    <span class="c1">#    toolbox.register(&quot;attr_bool&quot;, random.randit, 0, 1)</span>
    <span class="c1">#    toolbox.register(&quot;individual&quot;, deap.tools.initRepeat, deap.creator.Individual, toolbox.attr_bool, n=l_yi)</span>
    <span class="c1">#    toolbox.register(&quot;population&quot;, deap.tools.initRepeat, list, toolbox.individual)</span>
    <span class="c1">#</span>
    <span class="c1">#    def obj_func(individual):</span>
    <span class="c1">#        return np.sum(individual)</span>
    <span class="c1">#</span>
    <span class="c1">#    toolbox.register(&quot;evaluate&quot;, obj_func)</span>
    <span class="c1">#    toolbox.register(&quot;mate&quot;, tools.cxTwoPoint)</span>
    <span class="c1">#    toolbox.register(&quot;mutate&quot;, tools.mutFlipBit, indpb=0.05)</span>
    <span class="c1">#    toolbox.register(&quot;select&quot;, tools.selTournament, tournsize=3)</span>
    <span class="c1">#</span>
    <span class="c1">#    population = toolbox.population(n=300)</span>
    <span class="c1">#</span>
    <span class="c1">#    NGEN=40</span>
    <span class="c1">#    for gen in range(NGEN):</span>
    <span class="c1">#        offspring = algorithms.varAnd(population, toolbox, cxpb=0.5, mutpb=0.1)</span>
    <span class="c1">#        fits = toolbox.map(toolbox.evaluate, offspring)</span>
    <span class="c1">#        for fit, ind in zip(fits, offspring):</span>
    <span class="c1">#            ind.fitness.values = fit</span>
    <span class="c1">#        population = toolbox.select(offspring, k=len(population))</span>
    <span class="c1">#    top10 = tools.selBest(population, k=10)</span>

   <span class="c1"># # My attempt at using a heuristic approach</span>
   <span class="c1"># # Make new random guesses for yi, and test to find a feasible one</span>
   <span class="c1"># l_yi = len(xi)</span>
   <span class="c1"># Nguess = 10</span>
   <span class="c1"># yiguess = eos.chemicalpotential(P, np.array([rhov_tmp]), yi_g_tmp, T)[]</span>
   <span class="c1"># rhov_guess = []</span>
   <span class="c1"># obj_guess = []</span>
   <span class="c1"># for j in range(maxiter):  # iterate until 10 feasible options are found</span>
   <span class="c1">#     yi_g_tmp = np.zeros(l_yi)</span>
   <span class="c1">#     # Make guesses for yi</span>
   <span class="c1">#     yi_g_tmp[0:-1] = np.random.random((1, l_yi - 1))[0]</span>
   <span class="c1">#     yi_g_tmp[-1] = 1 - np.sum(yi_g_tmp)</span>
   <span class="c1">#     # Test guess</span>
   <span class="c1">#     phiv, rhov, flagv = calc_phiv(P, T, yi, eos, rhodict={})</span>
   <span class="c1">#     if all(np.isnan(muiv_tmp) == False):</span>

   <span class="c1">#         yiguess.append(yi_g_tmp)</span>
   <span class="c1">#         rhov_guess.append(rhov_tmp)</span>

   <span class="c1">#         phiv = np.exp(muiv_tmp)</span>
   <span class="c1">#         obj_tmp = np.sum(xi * phil / phiv) - 1</span>
   <span class="c1">#         logger.debug(&quot;rhov, muiv, phiv, obj_tmp&quot; % str([rhov_tmp, muiv, phiv, obj_tmp]))</span>

   <span class="c1">#         obj_guess.append(np.abs(obj_tmp))</span>

   <span class="c1">#     if len(yiguess) == Nguess:</span>
   <span class="c1">#         break</span>
   <span class="c1"># # Choose the yi value to continue with based on new guesses</span>
   <span class="c1"># ind = np.where(obj_guess == min(obj_guess))[0]</span>
   <span class="c1"># logger.info(&quot;Obj Value: {}, Index: {}&quot;.format(obj_guess,ind))</span>
   <span class="c1"># yi = yiguess[ind]</span>
   <span class="c1"># rhov = rhov_guess[ind]</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">yi_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="o">.</span><span class="mi">99</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span> <span class="c1"># Guess for yi</span>
    <span class="n">obj_ext</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#flag_ext = []</span>
    <span class="n">yi_total2_ext</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rho_ext</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phi_ext</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">yi_ext</span><span class="p">:</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">yi</span><span class="p">]</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj_yi</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
        <span class="n">obj_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Obj yi </span><span class="si">{}</span><span class="s2"> total1 - total2 = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span><span class="n">obj</span><span class="p">))</span>

   <span class="c1"># plt.plot(yi_ext,obj_ext,&quot;.-b&quot;)</span>
   <span class="c1"># plt.plot(yi_ext,np.array(obj_ext)+np.array(yi_total2_ext),&quot;.-r&quot;)</span>
   <span class="c1"># plt.show()</span>

    <span class="n">obj_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_ext</span><span class="p">)</span>
    <span class="c1">#flag_ext = np.array(flag_ext)</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_ext</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Number of valid mole fractions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">yi_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">obj_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Remove any NaN</span>
        <span class="n">obj_tmp</span>  <span class="o">=</span>  <span class="n">obj_ext</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_ext</span><span class="p">)]</span>
        <span class="n">yi_tmp</span>   <span class="o">=</span>   <span class="n">yi_ext</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_ext</span><span class="p">)]</span>
        <span class="c1">#flag_tmp = flag_ext[~np.isnan(obj_ext)]</span>
 
    <span class="c1">#    # Assess vapor values</span>
    <span class="c1">#    ind = [i for i in range(len(flag_tmp)) if flag_tmp[i] not in [1,4]]</span>
    <span class="c1">#    if ind:</span>
    <span class="c1">#        obj_tmp = [obj_tmp[i] for i in ind]</span>
    <span class="c1">#        yi_tmp = [yi_tmp[i] for i in ind]</span>

        <span class="c1"># Choose values with lowest objective function</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obj_tmp</span><span class="p">)</span><span class="o">==</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obj_tmp</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj_tmp</span> <span class="o">=</span> <span class="n">obj_tmp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">yi_tmp</span> <span class="o">=</span> <span class="n">yi_tmp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Found new guess in yi: </span><span class="si">{}</span><span class="s2">, Obj: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi_tmp</span><span class="p">,</span><span class="n">obj_tmp</span><span class="p">))</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">yi_tmp</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">yi</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">yi</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                       Find new Yi                                  #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>


<div class="viewcode-block" id="obj_yi"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.obj_yi.html#despasito.thermodynamics.calc.obj_yi">[docs]</a><span class="k">def</span> <span class="nf">obj_yi</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function for solving for stable vapor mole fraction.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj : numpy.ndarray</span>
<span class="sd">        Objective function for solving for vapor mole fractions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">yi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="n">yi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">yi</span><span class="p">]</span>

    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">yinew</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span>
    <span class="n">yinew_total_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>

    <span class="n">yi2</span> <span class="o">=</span> <span class="n">yinew</span><span class="o">/</span><span class="n">yinew_total_1</span>
    <span class="n">phiv2</span><span class="p">,</span> <span class="n">rhov2</span><span class="p">,</span> <span class="n">flagv2</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi2</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>
    <span class="n">yinew</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv2</span>
    <span class="n">yinew_total_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;yi_totals </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yinew_total_1</span><span class="p">,</span><span class="n">yinew_total_2</span><span class="p">))</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">yinew_total_1</span> <span class="o">-</span> <span class="n">yinew_total_2</span>
    
    <span class="k">return</span> <span class="n">obj</span></div>


<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Solve Xi in root finding              #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="solve_xi_root"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_xi_root.html#despasito.thermodynamics.calc.solve_xi_root">[docs]</a><span class="k">def</span> <span class="nf">solve_xi_root</span><span class="p">(</span><span class="n">xi0</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function used to search liquid mole fraction and solve inner loop of dew point calculations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Guess in liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    phiv : float</span>
<span class="sd">        Fugacity coefficient of vapor at system pressure</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj_value : list</span>
<span class="sd">        List of percent change between guess that is input and the updated version from recalculating with fugacity coefficients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">xi0</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi0</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">xi0</span>

    <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">xinew</span> <span class="o">=</span> <span class="n">yi</span> <span class="o">*</span> <span class="n">phiv</span> <span class="o">/</span> <span class="n">phil</span>
    <span class="n">xinew</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xinew</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    xi: </span><span class="si">{}</span><span class="s1">, xinew: </span><span class="si">{}</span><span class="s1">, Percent Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">xinew</span><span class="p">,((</span><span class="n">xinew</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span><span class="o">/</span><span class="n">xi</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>

    <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xi</span><span class="o">==</span><span class="nb">min</span><span class="p">(</span><span class="n">xi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xinew</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span><span class="o">/</span><span class="n">xi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                       Solve Yi in Root Finding                     #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>

<div class="viewcode-block" id="solve_yi_root"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_yi_root.html#despasito.thermodynamics.calc.solve_yi_root">[docs]</a><span class="k">def</span> <span class="nf">solve_yi_root</span><span class="p">(</span><span class="n">yi0</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function used to search vapor mole fraction and solve inner loop of bubble point calculations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yi0 : numpy.ndarray</span>
<span class="sd">        Guess in vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    phil : float</span>
<span class="sd">        Fugacity coefficient of liquid at system pressure</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj_value : list</span>
<span class="sd">        List of absolute change between guess that is input and the updated version from recalculating with fugacity coefficients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">yi0</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi0</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">yi0</span>

    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">yinew</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span>
    <span class="n">yinew</span> <span class="o">=</span> <span class="n">yinew</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yinew</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    yi: </span><span class="si">{}</span><span class="s1">, yinew: </span><span class="si">{}</span><span class="s1">, Percent Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span><span class="n">yinew</span><span class="p">,((</span><span class="n">yinew</span> <span class="o">-</span> <span class="n">yi</span><span class="p">)</span><span class="o">/</span><span class="n">yi</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>

    <span class="n">ind_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yi</span><span class="o">==</span><span class="nb">min</span><span class="p">(</span><span class="n">yi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yinew</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span><span class="o">-</span><span class="n">yi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">])</span><span class="o">/</span><span class="n">yi</span><span class="p">[</span><span class="n">ind_tmp</span><span class="p">]</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Solve P xT                            #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="solve_P_xiT"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_P_xiT.html#despasito.thermodynamics.calc.solve_P_xiT">[docs]</a><span class="k">def</span> <span class="nf">solve_P_xiT</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function used to search pressure values and solve outer loop of P bubble point calculations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Guess in pressure of the system [Pa]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>
<span class="sd">    </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj_value : float</span>
<span class="sd">        :math:`\sum\frac{x_{i}\{phi_l}{\phi_v}-1`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">yi_global</span>

    <span class="k">if</span> <span class="n">P</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">10.0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;P Guess: </span><span class="si">{}</span><span class="s2"> Pa&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>

    <span class="c1">#find liquid density</span>
    <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">yinew</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">solve_yi_xiT</span><span class="p">(</span><span class="n">yi_global</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
    <span class="n">yi_global</span> <span class="o">=</span> <span class="n">yi_global</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi_global</span><span class="p">)</span>

    <span class="c1">#given final yi recompute</span>
    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi_global</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">Pv_test</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">rhov</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Nav</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi_global</span><span class="p">)</span>
    <span class="n">obj_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Obj Func: </span><span class="si">{}</span><span class="s1">, Pset: </span><span class="si">{}</span><span class="s1">, Pcalc: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_value</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Pv_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">obj_value</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Solve P yT                            #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="solve_P_yiT"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.solve_P_yiT.html#despasito.thermodynamics.calc.solve_P_yiT">[docs]</a><span class="k">def</span> <span class="nf">solve_P_yiT</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Objective function used to search pressure values and solve outer loop of P dew point calculations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        Guess in pressure of the system [Pa]</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj_value : list</span>
<span class="sd">        :math:`\sum\frac{y_{i}\{phi_v}{\phi_l}-1`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">xi_global</span>

    <span class="k">if</span> <span class="n">P</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">10.0</span>

    <span class="c1">#find liquid density</span>
    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">xi_global</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">solve_xi_yiT</span><span class="p">(</span><span class="n">xi_global</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
    <span class="n">xi_global</span> <span class="o">=</span> <span class="n">xi_global</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi_global</span><span class="p">)</span>

    <span class="c1">#given final yi recompute</span>
    <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi_global</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">Pv_test</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">rhov</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Nav</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi_global</span><span class="p">)</span>
    <span class="n">obj_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi_global</span> <span class="o">*</span> <span class="n">phil</span> <span class="o">/</span> <span class="n">phiv</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Obj Func: </span><span class="si">{}</span><span class="s1">, Pset: </span><span class="si">{}</span><span class="s1">, Pcalc: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_value</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Pv_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">obj_value</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                   Set Psat for Critical Components                 #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="setPsat"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.setPsat.html#despasito.thermodynamics.calc.setPsat">[docs]</a><span class="k">def</span> <span class="nf">setPsat</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">eos</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate dummy value for component saturation pressure if it is above its critical point.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ind : int</span>
<span class="sd">        Index of bead that is above critical point</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Psat : float</span>
<span class="sd">        Dummy value of saturation pressure [Pa]</span>
<span class="sd">    NaNbead : str</span>
<span class="sd">        Bead name of the component that is above it&#39;s critical point</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">])):</span>
        <span class="k">if</span> <span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CO2&quot;</span><span class="p">:</span>
            <span class="n">Psat</span> <span class="o">=</span> <span class="mf">10377000.0</span>
        <span class="k">elif</span> <span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N2&quot;</span><span class="p">:</span>
            <span class="n">Psat</span> <span class="o">=</span> <span class="mf">7377000.0</span>
        <span class="k">elif</span> <span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;CH4&quot;</span> <span class="ow">in</span> <span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
            <span class="n">Psat</span> <span class="o">=</span> <span class="mf">6377000.0</span>
        <span class="k">elif</span> <span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;CH3CH3&quot;</span> <span class="ow">in</span> <span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
            <span class="n">Psat</span> <span class="o">=</span> <span class="mf">7377000.0</span>
        <span class="k">elif</span> <span class="n">eos</span><span class="o">.</span><span class="n">_nui</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1">#Psat = np.nan</span>
            <span class="n">Psat</span> <span class="o">=</span> <span class="mf">7377000.0</span>
            <span class="n">NaNbead</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">_beads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Bead, </span><span class="si">{}</span><span class="s2">, is above its critical point. Psat is assumed to be </span><span class="si">{}</span><span class="s2">. To add an exception go to thermodynamics.calc.setPsat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NaNbead</span><span class="p">,</span><span class="n">Psat</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;NaNbead&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
       <span class="n">NaNbead</span> <span class="o">=</span> <span class="s2">&quot;No NaNbead&quot;</span>
       <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No beads above their critical point&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Psat</span><span class="p">,</span> <span class="n">NaNbead</span> </div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc yT phase                         #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_yT_phase"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_yT_phase.html#despasito.thermodynamics.calc.calc_yT_phase">[docs]</a><span class="k">def</span> <span class="nf">calc_yT_phase</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{},</span> <span class="n">Pguess</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">meth</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span> <span class="n">pressure_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate dew point mole fraction and pressure given system vapor mole fraction and temperature.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Vapor mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>
<span class="sd">    Pguess : float, Optional, default: -1</span>
<span class="sd">        Guess the system pressure at the dew point. A negative value will force an estimation based on the saturation pressure of each component.</span>
<span class="sd">    meth : str, Optional, default: &quot;broyden1&quot;</span>
<span class="sd">        Choose the method used to solve the dew point calculation</span>
<span class="sd">    pressure_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used in the given method, &quot;meth&quot;, to solve the outer loop in the solving algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    flagl : int</span>
<span class="sd">        Flag identifying the fluid type for the liquid mole fractions, expected is liquid, 1. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true</span>
<span class="sd">    flagv : int</span>
<span class="sd">        Flag identifying the fluid type for the vapor mole fractions, expected is vapor or 0. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means ideal gas is assumed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">xi_global</span>

    <span class="c1"># Estimate pure component vapor pressures</span>
    <span class="n">Psat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">yi</span><span class="p">)):</span>
        <span class="n">yi_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
        <span class="n">yi_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rholsat</span><span class="p">,</span> <span class="n">rhogsat</span> <span class="o">=</span> <span class="n">calc_Psat</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">yi_tmp</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">NaNbead</span> <span class="o">=</span> <span class="n">setPsat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Component, </span><span class="si">{}</span><span class="s2">, is beyond it&#39;s critical point at </span><span class="si">{}</span><span class="s2"> K. Add an exception to setPsat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NaNbead</span><span class="p">,</span><span class="n">T</span><span class="p">))</span>

    <span class="c1"># Estimate initial pressure</span>
    <span class="k">if</span> <span class="n">Pguess</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">P</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi</span><span class="o">/</span><span class="n">Psat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pguess</span>

    <span class="c1"># Estimate initial xi</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;xi_global&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xi_global</span><span class="p">))):</span>
        <span class="n">xi_global</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="p">(</span><span class="n">yi</span> <span class="o">/</span> <span class="n">Psat</span><span class="p">)</span>
        <span class="n">xi_global</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi_global</span><span class="p">)</span>
        <span class="n">xi_global</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xi_global</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">xi_global</span> 

    <span class="c1">#Prange, Pguess = calc_Prange_yi(T, xi, yi, eos, rhodict, zi_opts=zi_opts)</span>
    <span class="c1">#logger.info(&quot;Given Pguess: {}, Suggested: {}&quot;.format(P, Pguess))</span>
    <span class="c1">#P = Pguess</span>

    <span class="c1">#################### Root Finding without Boundaries ###################</span>
    <span class="k">if</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;broyden2&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;jac_options&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reduction_method&#39;</span><span class="p">:</span> <span class="s1">&#39;simple&#39;</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hybr_broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;hybr_broyden2&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;jac_options&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reduction_method&#39;</span><span class="p">:</span> <span class="s1">&#39;simple&#39;</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">)</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">Pfinal</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s1">&#39;anderson&#39;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hybr&#39;</span><span class="p">,</span> <span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="s1">&#39;linearmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;diagbroyden&#39;</span><span class="p">,</span> <span class="s1">&#39;excitingmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;krylov&#39;</span><span class="p">,</span> <span class="s1">&#39;df-sane&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>

<span class="c1">#################### Minimization Methods with Boundaries ###################</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Prange</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Prange</span><span class="p">)],</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>

<span class="c1">#################### Root Finding with Boundaries ###################</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s2">&quot;brent&quot;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rtol&quot;</span><span class="p">:</span><span class="mf">1e-7</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">,</span><span class="s2">&quot;rtol&quot;</span><span class="p">,</span><span class="s2">&quot;maxiter&quot;</span><span class="p">,</span><span class="s2">&quot;full_output&quot;</span><span class="p">,</span><span class="s2">&quot;disp&quot;</span><span class="p">]:</span>
                <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">solve_P_yiT</span><span class="p">,</span> <span class="n">Prange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Prange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="o">**</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s2">&quot;least_squares&quot;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">Prange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Prange</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="o">**</span><span class="n">outer_dict</span><span class="p">)</span>

    <span class="c1">#Given final P estimate</span>
    <span class="k">if</span> <span class="n">meth</span> <span class="o">!=</span> <span class="s2">&quot;brent&quot;</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pfinal</span><span class="o">.</span><span class="n">x</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimization terminated successfully: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pfinal</span><span class="o">.</span><span class="n">success</span><span class="p">,</span><span class="n">Pfinal</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>

    <span class="c1">#find vapor density and fugacity</span>
    <span class="n">phiv</span><span class="p">,</span> <span class="n">rhov</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">calc_phiv</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">if</span> <span class="s2">&quot;tol&quot;</span> <span class="ow">in</span> <span class="n">zi_opts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zi_opts</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">zi_opts</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>

    <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">solve_xi_yiT</span><span class="p">(</span><span class="n">xi_global</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
    <span class="n">xi_global</span> <span class="o">=</span> <span class="n">xi</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">solve_P_yiT</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">flagl</span><span class="p">,</span> <span class="n">flagv</span><span class="p">,</span> <span class="n">obj</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc xT phase                         #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_xT_phase"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_xT_phase.html#despasito.thermodynamics.calc.calc_xT_phase">[docs]</a><span class="k">def</span> <span class="nf">calc_xT_phase</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{},</span> <span class="n">zi_opts</span><span class="o">=</span><span class="p">{},</span> <span class="n">Pguess</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">meth</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span> <span class="n">pressure_opts</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate bubble point mole fraction and pressure given system liquid mole fraction and temperature.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>
<span class="sd">    zi_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used to solve the inner loop in the solving algorithm</span>
<span class="sd">    Pguess : float, Optional, default: -1</span>
<span class="sd">        Guess the system pressure at the dew point. A negative value will force an estimation based on the saturation pressure of each component.</span>
<span class="sd">    meth : str, Optional, default: &quot;broyden1&quot;</span>
<span class="sd">        Choose the method used to solve the dew point calculation</span>
<span class="sd">    pressure_opts : dict, Optional, default: {}</span>
<span class="sd">        Options used in the given method, &quot;meth&quot;, to solve the outer loop in the solving algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    flagv : int</span>
<span class="sd">        Flag identifying the fluid type for the vapor mole fractions, expected is vapor or 0. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true, 4 means ideal gas is assumed</span>
<span class="sd">    flagl : int</span>
<span class="sd">        Flag identifying the fluid type for the liquid mole fractions, expected is liquid, 1. A value of 0 is vapor, 1 is liquid, 2 mean a critical fluid, 3 means that neither is true</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">yi_global</span>

    <span class="n">Psat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xi</span><span class="p">)):</span>
        <span class="n">xi_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xi_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rholsat</span><span class="p">,</span> <span class="n">rhogsat</span> <span class="o">=</span> <span class="n">calc_Psat</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi_tmp</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">NaNbead</span> <span class="o">=</span> <span class="n">setPsat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Component, </span><span class="si">{}</span><span class="s2">, is beyond it&#39;s critical point. Add an exception to setPsat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NaNbead</span><span class="p">))</span>

    <span class="c1"># Estimate initial pressure</span>
    <span class="k">if</span> <span class="n">Pguess</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">P</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span><span class="o">/</span><span class="n">Psat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pguess</span>

    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;yi_global&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yi_global</span><span class="p">))):</span>
        <span class="n">yi_global</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">Psat</span> <span class="o">/</span> <span class="n">P</span>
        <span class="n">yi_global</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yi_global</span><span class="p">)</span>
        <span class="n">yi_global</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">yi_global</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Guess yi in calc_xT_phase with Psat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yi_global</span><span class="p">))</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">yi_global</span>

<span class="c1">#    logger.info(&quot;Initial: P: {}, yi: {}&quot;.format(Pguess,str(yi)))</span>
<span class="c1">#    Pguess, yi = bubblepoint_guess(Pguess, yi, xi, T, phil, eos, rhodict)</span>
<span class="c1">#    logger.info(&quot;Updated: P: {}, yi: {}&quot;.format(Pguess,str(yi)))</span>

    <span class="n">Prange</span><span class="p">,</span> <span class="n">Pguess</span> <span class="o">=</span> <span class="n">calc_Prange_xi</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="o">=</span><span class="n">zi_opts</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Given Pguess: </span><span class="si">{}</span><span class="s2">, Suggested: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Pguess</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Pguess</span>

    <span class="k">if</span> <span class="n">meth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brent&quot;</span><span class="p">,</span> <span class="s2">&quot;least_squares&quot;</span><span class="p">,</span> <span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span> <span class="s1">&#39;hybr&#39;</span><span class="p">,</span> <span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="s1">&#39;linearmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;diagbroyden&#39;</span><span class="p">,</span> <span class="s1">&#39;excitingmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;krylov&#39;</span><span class="p">,</span> <span class="s1">&#39;df-sane&#39;</span><span class="p">,</span> <span class="s1">&#39;anderson&#39;</span><span class="p">,</span> <span class="s1">&#39;hybr_broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;hybr_broyden2&#39;</span><span class="p">,</span> <span class="s1">&#39;broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;broyden2&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Optimization method, </span><span class="si">{}</span><span class="s2">, not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">))</span>

    <span class="c1">#################### Root Finding without Boundaries ###################</span>
    <span class="k">if</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;broyden2&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;jac_options&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reduction_method&#39;</span><span class="p">:</span> <span class="s1">&#39;simple&#39;</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hybr_broyden1&#39;</span><span class="p">,</span> <span class="s1">&#39;hybr_broyden2&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;jac_options&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reduction_method&#39;</span><span class="p">:</span> <span class="s1">&#39;simple&#39;</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">)</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">Pfinal</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s1">&#39;anderson&#39;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hybr&#39;</span><span class="p">,</span> <span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="s1">&#39;linearmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;diagbroyden&#39;</span><span class="p">,</span> <span class="s1">&#39;excitingmixing&#39;</span><span class="p">,</span> <span class="s1">&#39;krylov&#39;</span><span class="p">,</span> <span class="s1">&#39;df-sane&#39;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>

<span class="c1">#################### Minimization Methods with Boundaries ###################</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">]:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Prange</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Prange</span><span class="p">)],</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">outer_dict</span><span class="p">)</span>

<span class="c1">#################### Root Finding with Boundaries ###################</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s2">&quot;brent&quot;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rtol&quot;</span><span class="p">:</span><span class="mf">1e-7</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">,</span><span class="s2">&quot;rtol&quot;</span><span class="p">,</span><span class="s2">&quot;maxiter&quot;</span><span class="p">,</span><span class="s2">&quot;full_output&quot;</span><span class="p">,</span><span class="s2">&quot;disp&quot;</span><span class="p">]:</span>
                <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">Prange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Prange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="o">**</span><span class="n">outer_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s2">&quot;least_squares&quot;</span><span class="p">:</span>
        <span class="n">outer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pressure_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outer_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the method, </span><span class="si">{}</span><span class="s2">, with the following options:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span><span class="n">outer_dict</span><span class="p">))</span>
        <span class="n">Pfinal</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">solve_P_xiT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">Prange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Prange</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="n">zi_opts</span><span class="p">),</span> <span class="o">**</span><span class="n">outer_dict</span><span class="p">)</span>

    <span class="c1">#Given final P estimate</span>
    <span class="k">if</span> <span class="n">meth</span> <span class="o">!=</span> <span class="s2">&quot;brent&quot;</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pfinal</span><span class="o">.</span><span class="n">x</span>

    <span class="c1">#find liquid density and fugacity</span>
    <span class="n">phil</span><span class="p">,</span> <span class="n">rhol</span><span class="p">,</span> <span class="n">flagl</span> <span class="o">=</span> <span class="n">calc_phil</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">if</span> <span class="s2">&quot;tol&quot;</span> <span class="ow">in</span> <span class="n">zi_opts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zi_opts</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">zi_opts</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>

    <span class="n">yi</span><span class="p">,</span> <span class="n">phiv</span><span class="p">,</span> <span class="n">flagv</span> <span class="o">=</span> <span class="n">solve_yi_xiT</span><span class="p">(</span><span class="n">yi_global</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">,</span> <span class="o">**</span><span class="n">zi_opts</span><span class="p">)</span>
    <span class="n">yi_global</span> <span class="o">=</span> <span class="n">yi</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">solve_P_xiT</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="n">rhodict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">yi_global</span><span class="p">,</span> <span class="n">flagv</span><span class="p">,</span> <span class="n">flagl</span><span class="p">,</span> <span class="n">obj</span></div>

<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc PT phase                         #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_PT_phase"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_PT_phase.html#despasito.thermodynamics.calc.calc_PT_phase">[docs]</a><span class="k">def</span> <span class="nf">calc_PT_phase</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Not Complete**</span>
<span class="sd">    Calculate the PT phase diagram given liquid mole fraction and temperature</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    P : float</span>
<span class="sd">        Pressure of the system [Pa]</span>
<span class="sd">    yi : numpy.ndarray</span>
<span class="sd">        Mole fraction of each component, sum(yi) should equal 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">Psat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xi</span><span class="p">)):</span>
        <span class="n">xi_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xi_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rholsat</span><span class="p">,</span> <span class="n">rhogsat</span> <span class="o">=</span> <span class="n">calc_Psat</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">xi_tmp</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">NaNbead</span> <span class="o">=</span> <span class="n">setPsat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Psat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Component, </span><span class="si">{}</span><span class="s2">, is beyond it&#39;s critical point. Add an exception to setPsat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NaNbead</span><span class="p">))</span>

    <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

    <span class="c1">#estimate ki</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">Psat</span> <span class="o">/</span> <span class="n">P</span>

    <span class="c1">#estimate beta (not thermodynamic) vapor frac</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ki</span> <span class="o">*</span> <span class="n">zi</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ki</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span></div>


<span class="c1">######################################################################</span>
<span class="c1">#                                                                    #</span>
<span class="c1">#                              Calc dadT                             #</span>
<span class="c1">#                                                                    #</span>
<span class="c1">######################################################################</span>
<div class="viewcode-block" id="calc_dadT"><a class="viewcode-back" href="../../../_autosummary/despasito.thermodynamics.calc.calc_dadT.html#despasito.thermodynamics.calc.calc_dadT">[docs]</a><span class="k">def</span> <span class="nf">calc_dadT</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eos</span><span class="p">,</span> <span class="n">rhodict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the derivative of the Helmholtz energy with respect to temperature, :math:`\frac{dA}{dT}`, give a list of density values and system conditions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rho : numpy.ndarray</span>
<span class="sd">        Density array. Length depends on values in rhodict [mol/:math:`m^3`]</span>
<span class="sd">    T : float</span>
<span class="sd">        Temperature of the system [K]</span>
<span class="sd">    xi : numpy.ndarray</span>
<span class="sd">        Liquid mole fraction of each component, sum(xi) should equal 1.0</span>
<span class="sd">    eos : obj</span>
<span class="sd">        An instance of the defined EOS class to be used in thermodynamic computations.</span>
<span class="sd">    rhodict : dict, Optional, default: {}</span>
<span class="sd">        Dictionary of options used in calculating pressure vs. mole </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dadT : numpy.ndarray</span>
<span class="sd">        Array of derivative values of Helmholtz energy with respect to temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="mf">1000.0</span>
    <span class="n">nrho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>

    <span class="c1">#computer rho+step and rho-step for better a bit better performance</span>
    <span class="n">Ap</span> <span class="o">=</span> <span class="n">calchelmholtz</span><span class="o">.</span><span class="n">calc_A</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rho</span><span class="p">]),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">T</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
    <span class="n">Am</span> <span class="o">=</span> <span class="n">calchelmholtz</span><span class="o">.</span><span class="n">calc_A</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rho</span><span class="p">]),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">T</span> <span class="o">-</span> <span class="n">step</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Ap</span> <span class="o">-</span> <span class="n">Am</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">step</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jennifer A Clark. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>